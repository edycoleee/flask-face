<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Face - User & Photo Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='page.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üé≠ Flask Face API</h1>
            <p class="subtitle">User & Photo Management System</p>
        </header>

        <div class="main-content">
            <!-- Tabs Navigation -->
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="users">üë• Users</button>
                <button class="tab-btn" data-tab="photos">üì∏ Photos</button>
                <button class="tab-btn" data-tab="training">üîÑ Database Build</button>
                <button class="tab-btn" data-tab="prediction">üîÆ Prediction</button>
                <button class="tab-btn" data-tab="verification">üîê Verification</button>
            </div>

            <!-- USERS SECTION -->
            <section id="users-tab" class="tab-content active">
                <div class="section-container">
                    <!-- Create User Form -->
                    <div class="card">
                        <h2>‚ûï Create New User</h2>
                        <form id="createUserForm" class="form">
                            <div class="form-group">
                                <label for="userName">Name</label>
                                <input type="text" id="userName" name="name" placeholder="Enter user name" required>
                            </div>
                            <div class="form-group">
                                <label for="userEmail">Email</label>
                                <input type="email" id="userEmail" name="email" placeholder="Enter user email" required>
                            </div>                            <div class="form-group">
                                <label for="userPassword">Password</label>
                                <input type="text" id="userPassword" name="password" placeholder="Enter password" required>
                                <small class="form-help">Password tidak di-encrypt (untuk development)</small>
                            </div>                            <button type="submit" class="btn btn-primary">Create User</button>
                        </form>
                        <div id="createUserMessage" class="message"></div>
                    </div>

                    <!-- Users List -->
                    <div class="card">
                        <h2>üìã Users List</h2>
                        <button class="btn btn-secondary" onclick="loadUsers()">üîÑ Refresh</button>
                        
                        <div id="usersContainer" class="users-list">
                            <div class="loading">Loading users...</div>
                        </div>
                    </div>

                    <!-- Edit User Modal -->
                    <div id="editUserModal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeEditUserModal()">&times;</span>
                            <h2>‚úèÔ∏è Edit User</h2>
                            <form id="editUserForm" class="form">
                                <input type="hidden" id="editUserId" name="id">
                                <div class="form-group">
                                    <label for="editUserName">Name</label>
                                    <input type="text" id="editUserName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="editUserEmail">Email</label>
                                    <input type="email" id="editUserEmail" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="editUserPassword">Password</label>
                                    <input type="text" id="editUserPassword" name="password" required>
                                    <small class="form-help">Password tidak di-encrypt (untuk development)</small>
                                </div>
                                <button type="submit" class="btn btn-primary">Update User</button>
                            </form>
                            <div id="editUserMessage" class="message"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PHOTOS SECTION -->
            <section id="photos-tab" class="tab-content">
                <div class="section-container">
                    <!-- Select User for Photos -->
                    <div class="card">
                        <h2>üë§ Select User</h2>
                        <div class="form-group">
                            <label for="photoUserId">User</label>
                            <select id="photoUserId" onchange="onUserSelected()">
                                <option value="">-- Select User --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Upload Photos -->
                    <div class="card" id="uploadSection" style="display: none;">
                        <h2>üì§ Upload Photos</h2>
                        
                        <div class="upload-tabs">
                            <button class="upload-tab-btn active" data-upload-tab="singleUpload">Single Photo</button>
                            <button class="upload-tab-btn" data-upload-tab="multipleUpload">Multiple Photos</button>
                            <button class="upload-tab-btn" data-upload-tab="cameraUpload">üì∑ Capture from Camera</button>
                        </div>

                        <!-- Single Photo Upload -->
                        <div id="singleUploadTab" class="upload-tab-content active">
                            <form id="uploadSingleForm" class="form">
                                <div class="form-group">
                                    <label for="singlePhotoFile">Select Photo (JPG/PNG)</label>
                                    <input type="file" id="singlePhotoFile" name="file" accept="image/jpeg,image/png" required>
                                </div>
                                <div class="preview-container" id="singlePreview"></div>
                                <button type="submit" class="btn btn-primary">Upload Photo</button>
                            </form>
                            <div id="singleUploadMessage" class="message"></div>
                        </div>

                        <!-- Multiple Photos Upload -->
                        <div id="multipleUploadTab" class="upload-tab-content">
                            <form id="uploadMultipleForm" class="form">
                                <div class="form-group">
                                    <label for="multiplePhotoFiles">Select Photos (JPG/PNG)</label>
                                    <input type="file" id="multiplePhotoFiles" name="files" accept="image/jpeg,image/png" multiple required>
                                </div>
                                <div class="preview-container" id="multiplePreview"></div>
                                <button type="submit" class="btn btn-primary">Upload Photos</button>
                            </form>
                            <div id="multipleUploadMessage" class="message"></div>
                        </div>

                        <!-- Camera Capture -->
                        <div id="cameraUploadTab" class="upload-tab-content">
                            <div class="camera-container">
                                <!-- Error Message (displayed at top) -->
                                <div id="cameraErrorMessage" class="camera-error" style="display: none;"></div>
                                
                                <!-- Camera Controls -->
                                <div class="camera-controls">
                                    <button type="button" class="btn btn-secondary" id="startCameraBtn" onclick="openCamera()">üé• Buka Kamera</button>
                                    <button type="button" class="btn btn-secondary" id="stopCameraBtn" onclick="closeCamera()" style="display: none;">‚èπÔ∏è Tutup Kamera</button>
                                </div>
                                
                                <!-- Video Stream -->
                                <div id="videoContainer" class="video-container" style="display: none;">
                                    <video id="cameraStream" class="camera-stream" autoplay playsinline></video>
                                    <div class="camera-overlay">
                                        <div class="camera-frame"></div>
                                    </div>
                                </div>
                                
                                <!-- Hidden Canvas for Capture -->
                                <canvas id="captureCanvas" style="display: none;"></canvas>
                                
                                <!-- Capture Button (shown when camera active) -->
                                <div id="captureContainer" class="capture-controls" style="display: none;">
                                    <button type="button" class="btn btn-primary btn-large" id="captureBtn" onclick="captureImage()">üì∏ Ambil Foto</button>
                                </div>
                                
                                <!-- Captured Image Preview -->
                                <div id="cameraPreview" class="preview-container"></div>
                                
                                <!-- Upload Form (shown after capture) -->
                                <form id="uploadCameraForm" class="form" style="display: none;">
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">‚úÖ Upload Foto</button>
                                        <button type="button" class="btn btn-secondary" onclick="retakePhoto()">üîÑ Ambil Ulang</button>
                                    </div>
                                </form>
                                
                                <!-- Status Message -->
                                <div id="cameraUploadMessage" class="message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Photos Gallery -->
                    <div class="card" id="photosSection" style="display: none;">
                        <h2>üñºÔ∏è User Photos Gallery</h2>
                        <button class="btn btn-secondary" onclick="loadUserPhotos()">üîÑ Refresh</button>
                        
                        <div id="photosContainer" class="photos-gallery">
                            <div class="loading">No user selected</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- DATABASE BUILD SECTION -->
            <section id="training-tab" class="tab-content">
                <div class="section-container">
                    <!-- Database Build Configuration -->
                    <div class="card">
                        <h2>üìä Build Face Database</h2>
                        <p class="card-description">Extract face embeddings from your dataset (10-30 seconds)</p>
                        
                        <div class="info-box" style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                            <h4 style="margin: 0 0 10px 0; color: #1976d2;">‚ÑπÔ∏è How it works:</h4>
                            <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                <li>‚úÖ Uses pre-trained InsightFace model (no training needed)</li>
                                <li>‚úÖ Scans all photos in <code>dataset/</code> folder</li>
                                <li>‚úÖ Extracts 512-D face embeddings</li>
                                <li>‚úÖ Always full rebuild (10-30 seconds)</li>
                                <li>‚úÖ Auto-cleanup orphaned data</li>
                            </ul>
                        </div>
                        
                        <form id="trainingForm" class="form">
                            <div class="info-box" style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-bottom: 15px;">
                                <strong>‚ö° Quick Rebuild:</strong> No parameters needed! Just click the button below to rebuild the entire database.
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-large" id="startTrainingBtn">
                                    ÔøΩ Build Database Now
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="checkModelStatus()">
                                    üìä Check Database Status
                                </button>
                            </div>
                        </form>
                        <div id="trainingMessage" class="message"></div>
                    </div>

                    <!-- Build Progress -->
                    <div class="card" id="trainingProgressCard" style="display: none;">
                        <h2>‚è≥ Building Database</h2>
                        <div id="trainingProgress" class="training-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                            <p class="progress-text" id="progressText">Initializing...</p>
                        </div>
                    </div>

                    <!-- Build Progress -->
                    <div class="card" id="trainingResultsCard" style="display: none;">
                        <h2>ÔøΩ Database Build Results</h2>
                        <div id="trainingResults" class="training-results">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- Model Status -->
                    <div class="card">
                        <h2>üîç Current Model Status</h2>
                        <button class="btn btn-secondary" onclick="checkModelStatus()">üîÑ Refresh Status</button>
                        <div id="modelStatus" class="model-status">
                            <div class="loading">Loading model status...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PREDICTION SECTION -->
            <section id="prediction-tab" class="tab-content">
                <div class="section-container">
                    <!-- Model Status Check -->
                    <div class="card">
                        <h2>ü§ñ Database Status</h2>
                        <button class="btn btn-secondary" onclick="checkPredictionModelStatus()">üîÑ Refresh Status</button>
                        <div id="predictionModelStatus" class="model-status">
                            <div class="loading">Loading database status...</div>
                        </div>
                    </div>

                    <!-- Prediction Input -->
                    <div class="card">
                        <h2>üîÆ Face Recognition Prediction</h2>
                        <p class="card-description">Upload atau capture foto untuk identifikasi wajah</p>
                        
                        <div class="upload-tabs">
                            <button class="upload-tab-btn active" data-upload-tab="predictUpload">üì§ Upload Photo</button>
                            <button class="upload-tab-btn" data-upload-tab="predictCamera">üì∑ Capture from Camera</button>
                        </div>

                        <!-- Upload Photo for Prediction -->
                        <div id="predictUploadTab" class="upload-tab-content active">
                            <form id="predictUploadForm" class="form">
                                <div class="form-group">
                                    <label for="predictPhotoFile">Select Photo (JPG/PNG)</label>
                                    <input type="file" id="predictPhotoFile" name="file" accept="image/jpeg,image/png" required>
                                </div>
                                <div class="preview-container" id="predictUploadPreview"></div>
                                <button type="submit" class="btn btn-primary btn-large">üîç Predict Face</button>
                            </form>
                            <div id="predictUploadMessage" class="message"></div>
                        </div>

                        <!-- Camera Capture for Prediction -->
                        <div id="predictCameraTab" class="upload-tab-content">
                            <div class="camera-container">
                                <!-- Error Message -->
                                <div id="predictCameraErrorMessage" class="camera-error" style="display: none;"></div>
                                
                                <!-- Camera Controls -->
                                <div class="camera-controls">
                                    <button type="button" class="btn btn-secondary" id="startPredictCameraBtn" onclick="openPredictCamera()">üé• Buka Kamera</button>
                                    <button type="button" class="btn btn-secondary" id="stopPredictCameraBtn" onclick="closePredictCamera()" style="display: none;">‚èπÔ∏è Tutup Kamera</button>
                                </div>
                                
                                <!-- Video Stream -->
                                <div id="predictVideoContainer" class="video-container" style="display: none;">
                                    <video id="predictCameraStream" class="camera-stream" autoplay playsinline></video>
                                    <div class="camera-overlay">
                                        <div class="camera-frame"></div>
                                    </div>
                                </div>
                                
                                <!-- Hidden Canvas -->
                                <canvas id="predictCaptureCanvas" style="display: none;"></canvas>
                                
                                <!-- Capture Button -->
                                <div id="predictCaptureContainer" class="capture-controls" style="display: none;">
                                    <button type="button" class="btn btn-primary btn-large" id="predictCaptureBtn" onclick="capturePredictImage()">üì∏ Ambil Foto</button>
                                </div>
                                
                                <!-- Captured Image Preview -->
                                <div id="predictCameraPreview" class="preview-container"></div>
                                
                                <!-- Predict Form -->
                                <form id="predictCameraForm" class="form" style="display: none;">
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary btn-large">üîç Prediksi Wajah</button>
                                        <button type="button" class="btn btn-secondary" onclick="retakePredictPhoto()">üîÑ Ambil Ulang</button>
                                    </div>
                                </form>
                                
                                <!-- Status Message -->
                                <div id="predictCameraMessage" class="message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Results -->
                    <div class="card" id="predictionResultsCard" style="display: none;">
                        <h2>üìä Prediction Results</h2>
                        <div id="predictionResults" class="prediction-results">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- VERIFICATION SECTION (1:1) -->
            <section id="verification-tab" class="tab-content">
                <div class="section-container">
                    <!-- Info Card -->
                    <div class="card info-card">
                        <h2>üîê Face Verification (1:1)</h2>
                        <p class="card-description">
                            <strong>Verification Mode:</strong> Verifikasi apakah wajah cocok dengan user tertentu.<br>
                            <strong>Input:</strong> Email/User ID + Foto wajah<br>
                            <strong>Process:</strong> Verify apakah foto cocok dengan user yang diklaim (1:1 comparison)<br>
                            <strong>Speed:</strong> ‚ö° Lebih cepat dari Prediction (constant time ~1.2s)
                        </p>
                    </div>

                    <!-- Step 1: Email Lookup -->
                    <div class="card">
                        <h2>üìß Step 1: Masukkan Email</h2>
                        <p class="card-description">Masukkan email untuk lookup User ID</p>
                        
                        <form id="verifyEmailForm" class="form">
                            <div class="form-group">
                                <label for="verifyEmail">Email Address</label>
                                <input type="email" id="verifyEmail" name="email" placeholder="john@example.com" required>
                                <small class="form-help">Email yang terdaftar di sistem</small>
                            </div>
                            <button type="submit" class="btn btn-primary">üîç Lookup User</button>
                        </form>
                        <div id="emailLookupMessage" class="message"></div>
                        
                        <!-- User Info Display -->
                        <div id="userInfoDisplay" style="display: none; margin-top: 20px;">
                            <div class="user-info-box">
                                <h3>‚úÖ User Found</h3>
                                <div class="user-details-grid">
                                    <div class="detail-item">
                                        <span class="label">User ID:</span>
                                        <span class="value" id="foundUserId">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Name:</span>
                                        <span class="value" id="foundUserName">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Email:</span>
                                        <span class="value" id="foundUserEmail">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Face Verification -->
                    <div class="card" id="verifyFaceSection" style="display: none;">
                        <h2>üì∏ Step 2: Verifikasi Wajah</h2>
                        <p class="card-description">Upload atau capture foto untuk verifikasi identitas</p>
                        
                        <div class="upload-tabs">
                            <button class="upload-tab-btn active" data-upload-tab="verifyUpload">üì§ Upload Photo</button>
                            <button class="upload-tab-btn" data-upload-tab="verifyCamera">üì∑ Capture from Camera</button>
                        </div>

                        <!-- Upload Photo for Verification -->
                        <div id="verifyUploadTab" class="upload-tab-content active">
                            <form id="verifyUploadForm" class="form">
                                <div class="form-group">
                                    <label for="verifyPhotoFile">Select Photo (JPG/PNG)</label>
                                    <input type="file" id="verifyPhotoFile" name="file" accept="image/jpeg,image/png" required>
                                </div>
                                <div class="preview-container" id="verifyUploadPreview"></div>
                                <button type="submit" class="btn btn-primary btn-large">üîê Verify Face</button>
                            </form>
                            <div id="verifyUploadMessage" class="message"></div>
                        </div>

                        <!-- Camera Capture for Verification -->
                        <div id="verifyCameraTab" class="upload-tab-content">
                            <div class="camera-container">
                                <!-- Error Message -->
                                <div id="verifyCameraErrorMessage" class="camera-error" style="display: none;"></div>
                                
                                <!-- Camera Controls -->
                                <div class="camera-controls">
                                    <button type="button" class="btn btn-secondary" id="startVerifyCameraBtn" onclick="openVerifyCamera()">üé• Buka Kamera</button>
                                    <button type="button" class="btn btn-secondary" id="stopVerifyCameraBtn" onclick="closeVerifyCamera()" style="display: none;">‚èπÔ∏è Tutup Kamera</button>
                                </div>
                                
                                <!-- Video Stream -->
                                <div id="verifyVideoContainer" class="video-container" style="display: none;">
                                    <video id="verifyCameraStream" class="camera-stream" autoplay playsinline></video>
                                    <div class="camera-overlay">
                                        <div class="camera-frame"></div>
                                    </div>
                                </div>
                                
                                <!-- Hidden Canvas -->
                                <canvas id="verifyCaptureCanvas" style="display: none;"></canvas>
                                
                                <!-- Capture Button -->
                                <div id="verifyCaptureContainer" class="capture-controls" style="display: none;">
                                    <button type="button" class="btn btn-primary btn-large" id="verifyCaptureBtn" onclick="captureVerifyImage()">üì∏ Ambil Foto</button>
                                </div>
                                
                                <!-- Captured Image Preview -->
                                <div id="verifyCameraPreview" class="preview-container"></div>
                                
                                <!-- Verify Form -->
                                <form id="verifyCameraForm" class="form" style="display: none;">
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary btn-large">üîê Verify Face</button>
                                        <button type="button" class="btn btn-secondary" onclick="retakeVerifyPhoto()">üîÑ Ambil Ulang</button>
                                    </div>
                                </form>
                                
                                <!-- Status Message -->
                                <div id="verifyCameraMessage" class="message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Verification Results -->
                    <div class="card" id="verificationResultsCard" style="display: none;">
                        <h2>üìä Verification Results</h2>
                        <div id="verificationResults" class="verification-results">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Flask Face API v1.0 | Built with ‚ù§Ô∏è</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='page.js') }}"></script>
</body>
</html>
